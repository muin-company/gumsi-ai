#!/bin/bash

###############################################################################
# ê²€ì •ê³ ì‹œ ê¸°ì¶œë¬¸ì œ ìˆ˜ì§‘ ì „ì²´ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
# 
# ì‹¤í–‰ ìˆœì„œ:
#   1. PDF ë‹¤ìš´ë¡œë“œ (download-pdfs.js)
#   2. PDF íŒŒì‹± (parse-pdfs.js)
#   3. ë°ì´í„° ê²€ì¦ (validate-data.js)
###############################################################################

set -e  # ì—ëŸ¬ ë°œìƒì‹œ ì¤‘ë‹¨

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ë¡œê·¸ í•¨ìˆ˜
log_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

log_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

log_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

log_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# ë°°ë„ˆ
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                            â•‘"
echo "â•‘    ê²€ì •ê³ ì‹œ ê¸°ì¶œë¬¸ì œ ìë™ ìˆ˜ì§‘ ì‹œìŠ¤í…œ                     â•‘"
echo "â•‘                                                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ìŠ¤í¬ë¦½íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
cd "$SCRIPT_DIR"

log_info "ì‘ì—… ë””ë ‰í† ë¦¬: $SCRIPT_DIR"
echo ""

# Node.js í™•ì¸
if ! command -v node &> /dev/null; then
    log_error "Node.jsê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
    exit 1
fi

log_success "Node.js í™•ì¸ ì™„ë£Œ ($(node --version))"

# npm íŒ¨í‚¤ì§€ í™•ì¸
if [ ! -d "../node_modules" ]; then
    log_warning "node_modulesê°€ ì—†ìŠµë‹ˆë‹¤. npm install ì‹¤í–‰..."
    cd ..
    npm install
    cd "$SCRIPT_DIR"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# ë‹¨ê³„ë³„ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸ (ì˜µì…˜)
SKIP_DOWNLOAD=false
SKIP_PARSE=false
SKIP_VALIDATE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --skip-download)
            SKIP_DOWNLOAD=true
            shift
            ;;
        --skip-parse)
            SKIP_PARSE=true
            shift
            ;;
        --skip-validate)
            SKIP_VALIDATE=true
            shift
            ;;
        --help)
            echo "ì‚¬ìš©ë²•: $0 [ì˜µì…˜]"
            echo ""
            echo "ì˜µì…˜:"
            echo "  --skip-download   PDF ë‹¤ìš´ë¡œë“œ ìŠ¤í‚µ"
            echo "  --skip-parse      PDF íŒŒì‹± ìŠ¤í‚µ"
            echo "  --skip-validate   ë°ì´í„° ê²€ì¦ ìŠ¤í‚µ"
            echo "  --help            ë„ì›€ë§ í‘œì‹œ"
            exit 0
            ;;
        *)
            log_error "ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: $1"
            echo "ì‚¬ìš©ë²•: $0 --help"
            exit 1
            ;;
    esac
done

# ì‹œì‘ ì‹œê°„
START_TIME=$(date +%s)

###############################################################################
# 1ë‹¨ê³„: PDF ë‹¤ìš´ë¡œë“œ
###############################################################################

if [ "$SKIP_DOWNLOAD" = false ]; then
    log_info "1ë‹¨ê³„: PDF ë‹¤ìš´ë¡œë“œ ì‹œì‘"
    echo ""
    
    if node download-pdfs.js; then
        log_success "PDF ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
    else
        log_error "PDF ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨"
        exit 1
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
else
    log_warning "1ë‹¨ê³„: PDF ë‹¤ìš´ë¡œë“œ ìŠ¤í‚µë¨"
    echo ""
fi

###############################################################################
# 2ë‹¨ê³„: PDF íŒŒì‹±
###############################################################################

if [ "$SKIP_PARSE" = false ]; then
    log_info "2ë‹¨ê³„: PDF íŒŒì‹± ì‹œì‘"
    echo ""
    
    if node parse-pdfs.js; then
        log_success "PDF íŒŒì‹± ì™„ë£Œ"
    else
        log_error "PDF íŒŒì‹± ì‹¤íŒ¨"
        exit 1
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
else
    log_warning "2ë‹¨ê³„: PDF íŒŒì‹± ìŠ¤í‚µë¨"
    echo ""
fi

###############################################################################
# 3ë‹¨ê³„: ë°ì´í„° ê²€ì¦
###############################################################################

if [ "$SKIP_VALIDATE" = false ]; then
    log_info "3ë‹¨ê³„: ë°ì´í„° ê²€ì¦ ì‹œì‘"
    echo ""
    
    # ê²€ì¦ì€ ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (ê²½ê³ ë§Œ í‘œì‹œ)
    if node validate-data.js; then
        log_success "ë°ì´í„° ê²€ì¦ ì™„ë£Œ - ë¬¸ì œ ì—†ìŒ"
    else
        log_warning "ë°ì´í„° ê²€ì¦ ì™„ë£Œ - ì¼ë¶€ ë¬¸ì œ ë°œê²¬ (ë¦¬í¬íŠ¸ í™•ì¸)"
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
else
    log_warning "3ë‹¨ê³„: ë°ì´í„° ê²€ì¦ ìŠ¤í‚µë¨"
    echo ""
fi

###############################################################################
# ê²°ê³¼ ìš”ì•½
###############################################################################

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                    ì‘ì—… ì™„ë£Œ!                              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

log_success "ì „ì²´ ì‘ì—… ì™„ë£Œ (ì†Œìš” ì‹œê°„: ${DURATION}ì´ˆ)"
echo ""

# íŒŒì¼ ì¹´ìš´íŠ¸
PDF_COUNT=$(find ../data/pdfs -name "*.pdf" 2>/dev/null | wc -l | tr -d ' ')
JSON_COUNT=$(find ../data/questions -name "*.json" 2>/dev/null | wc -l | tr -d ' ')

echo "ğŸ“Š ê²°ê³¼ ìš”ì•½:"
echo "  - PDF íŒŒì¼: ${PDF_COUNT}ê°œ"
echo "  - JSON íŒŒì¼: ${JSON_COUNT}ê°œ"
echo ""

# ìƒì„±ëœ íŒŒì¼ ìœ„ì¹˜
echo "ğŸ“ ìƒì„±ëœ íŒŒì¼:"
echo "  - PDF: ../data/pdfs/"
echo "  - JSON: ../data/questions/"
echo "  - ë¦¬í¬íŠ¸: ../data/validation-report.txt"
echo "  - ë¡œê·¸: ../data/*.json"
echo ""

log_info "ê²€ì¦ ë¦¬í¬íŠ¸ í™•ì¸: cat ../data/validation-report.txt"
echo ""
